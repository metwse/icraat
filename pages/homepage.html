<script init>
    r.data = await session.dashboard()
</script>


<div class="top">
    <svg viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
        <path fill="currentColor" d="M275,66.56V255.1c0,.85-.96,1.28-1.6,.85l-50.09-34.77c-.32-.11-.43-.43-.43-.85v-85.28c0-.43-.53-.64-.85-.32l-71.46,60.93c-.32,.32-.96,.32-1.28,0l-71.46-60.93c-.32-.32-.85-.11-.85,.32v85.18c0,.32-.11,.53-.43,.85l-49.98,34.77c-.74,.53-1.6,0-1.6-.85V66.56c0-.32,.11-.53,.32-.85l24.99-21.59c.32-.32,.96-.32,1.28,0l97.62,83.05c.32,.32,.96,.32,1.28,0L248.1,44.23c.32-.32,.96-.32,1.28,0l24.99,21.59c.53,.11,.64,.43,.64,.74h0Z"></path>
        <polygon fill="none" points="300 100 200 100 200 0 100 0 100 100 0 100 0 200 100 200 100 300 200 300 200 200 300 200"></polygon>
    </svg>
    <input placeholder="Ara" />
</div>
<div class="main">
    <h2>Sınavlar</h2>
    <div class="content">
        <div class="buttons">
            <div class="filter">
                <div>
                    <button>
                        <div class="_inline-img">
                            Filtrele
                            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 13.5V3.75m0 9.75a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 3.75V16.5m12-3V3.75m0 9.75a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 3.75V16.5m-6-9V3.75m0 3.75a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 9.75V10.5"></path>
                            </svg>
                        </div>
                    </button>
                </div>
                <div class="list"></div>
            </div>
            <div class="analyze">
                <div>
                    <button class="start">
                        <div class="start _inline-img">
                            Analiz
                            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 107.5 7.5h-7.5V6z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z"></path>
                            </svg>
                        </div>
                        <div class="stop _inline-img" style="display: none">
                            İptal
                            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                    </button>
                    <div>
                        <button class="all analyze" style="display: none">
                            <div class="_inline-img">
                                Tümü
                                <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </button>
                        <button class="ok selected" style="display: none">
                            <div class="_inline-img">
                                Analiz Et
                                <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"></path>
                                </svg>
                            </div>
                        </button>
                        <button class="clear selected" style="display: none">
                            <div class="ok _inline-img">
                                Temizle
                                <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path>
                                </svg>
                            </div>
                        </button>
                    </div>
                </div>
                <ul></ul>
            </div>
        </div>

        <div class="exams">
            <icraat-loading></icraat-loading>
            <div class="list"></div>
        </div>

        <div class="select-filter">
            <nav>
                <h3>Filtreler</h3>
                <svg class="close" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </nav>
            <section class="publishers">
                <div class="title">
                    <h4>yayınevi</h4>
                    <input placeholder="Ara" />
                </div>
                <icraat-loading></icraat-loading>
                <ul></ul>
            </section>
            <hr />
            <section class="categories">
                <div class="title">
                    <h4>kategori</h4>
                    <input placeholder="Ara" />
                </div>
                <icraat-loading></icraat-loading>
                <ul></ul>
            </section>
        </div>
    </div>
</div>

<style>
    .r { display: flex; flex-direction: column; gap: 2em }

    .r .top { display: flex; padding: .75em 1em; border: 0.125em solid var(--bg-3); border-left-color: var(--t-1); border-right-color: var(--t-1); border-radius: 100em; align-items: center; gap: 1em }
    .r .top svg { height: 1.5em }    
    .r .top input { border: none; background: none; outline: none; flex-grow: 1 }

    /* ** ** ** ** */

    .r .main { display: flex; flex-direction: column; flex-grow: 1 }
    .r .main h2 { margin: 0; color: var(--color-3); font-size: 2em }
    .r .main .content { position: relative; flex-grow: 1 }
    
    /* ** ** ** ** */

    .r .content .exams icraat-loading { display: none }
    .r .content .exams.loading icraat-loading { display: block }
    .r.analyze .content .exams icraat-exam .select { display: block }
    .r.analyze .content .exams icraat-exam .view { display: none }

    /* ** ** ** ** */

    .r .content .buttons > * { margin-top: .5em }
    .r .content .buttons > div > div:first-of-type { display: flex; justify-content: space-between; gap: .25em; flex-wrap: wrap }
    .r .content .buttons > div > div:first-of-type > div { display: flex; gap: .25em; flex-wrap: wrap }
    .r .content .buttons button svg { height: 1.25em }
    .r .content .buttons button div { gap: .5em }
    .r .content .buttons button,
    .r .content .filter .list span { padding: .5em 1em; background: var(--bg-2); color: var(--color-2); border: .1em solid var(--bg-3); text-transform: uppercase; border-radius: 100em }
    
    .r .content .analyze:has(ul:not(:empty)) button.selected { display: inline-flex !important }
    .r .content .analyze ul { display: flex; margin: .25em 0 0; padding: 0; flex-wrap: wrap; gap: .25em }
    .r .content .analyze ul:empty { display: none }
    .r .content .analyze  li { display: inline-block; padding: .5em 1em; background: var(--bg-2); color: var(--color-2); border: .1em solid var(--bg-3); font-size: .8em; border-radius: 100em; list-style-type: none }
    .r .content .analyze  li .publisher { text-transform: uppercase }
    .r .content .analyze  li .name { text-decoration: underline var(--t-1) }

    .r .content .filter .list { display: flex; margin: .25em 0 0; padding: 0; width: 100%; overflow-x: auto; align-items: center; gap: .5em }
    .r .content .filter .list hr { display: inline-block; width: 1px; height: 2em; margin: 0; background: var(--bg-3); border: none }
    .r .content .filter .list span  { display: inline-block; padding: .25em .5em; font-size: .9em; white-space: nowrap }
    .r .content .filter .list::-webkit-scrollbar { height: 4px }
    .r .content .filter .list::-webkit-scrollbar-thumb { border-width: 0 }

    
    .r.analyze .content .analyze button .start { display: none }
    .r.analyze .content .analyze button .stop { display: inline-flex !important }
    .r.analyze .content .analyze .analyze { display: block !important }

    /*#region -- -- -- -- SELECT FILTER */

    .r .content .select-filter { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: var(--bg-2); z-index: 99 }
    
    .r .content .select-filter nav { display: flex; padding: 1em 1em; border: .125em solid var(--bg-3); border-left: none; border-right: none; justify-content: space-between; align-items: center }
    .r .content .select-filter nav h3 { margin: 0; text-transform: uppercase; font-weight: 500 }
    .r .content .select-filter nav svg { padding: .2em; height: 1.6em; background: var(--bg-2); border-radius: 100%; transition: filter .1s }
    .r .content .select-filter nav svg:hover { filter: brightness(1.1); cursor: pointer }
    
    .r .content .select-filter hr { margin: .5em 0 0; border: .125em solid var(--bg-3); border-bottom: 0 }

    .r .content .select-filter section .title { display: flex; padding: 1em 1em .5em; justify-content: space-between; align-items: center; gap: 2em }
    .r .content .select-filter section .title h4 { display: inline-block; margin: 0; text-transform: uppercase; font-weight: 500; font-size: .9em }
    .r .content .select-filter section .title input { border: none; border-bottom: .06125em solid var(--bg-3); flex-grow: 1 }
    .r .content .select-filter section ul { margin: 0; padding: 0 0 }
    .r .content .select-filter section  li { display: flex; padding: .5em 2em; background: var(--bg-2); transition: filter .1s; align-items: center; gap: .5em; list-style-type: none }
    .r .content .select-filter section  li:hover { filter: brightness(1.1); cursor: pointer }
    .r .content .select-filter section  li:before { content: ''; display: grid; width: 1em; height: 1em; background: var(--color); border-radius: .25em; place-items: center }
    .r .content .select-filter section  li.active:before { background: var(--t-1) }
    .r .content .select-filter section icraat-loading { display: none }
    .r .content .select-filter section.loading icraat-loading { display: block }

    /*#endregion*/
</style>

<script>
    var search = r.querySelector('.top input')
    search.oninput = () => {
        clearTimeout(search.timeout)
        search.timeout = setTimeout(() => exams.search(), 300)
    }


    var exams = r.querySelector('.exams')
    exams.list = exams.querySelector('.list')
    exams.load = data => {
        for (let exam of data) {
            let elem = d.createElement('icraat-exam')
            elem.attach(exam)
            elem.oncheck = analyze.add
            elem.checked = analyze.list.includes(exam)
            exams.list.appendChild(elem)
        }
    }
    exams.search = async () => {
        exams.list.innerHTML = '', exams.classList.add('loading')
        const random = Math.random()
        selectFilter.random.search = random
        const data = await session.search('exams', search.value, { filter: `${filter.active['publishers'].map(v => v.id)};${filter.active['exams.categories'].map(v => v.id)}` })
        if (selectFilter.random.search == random) exams.load(data), exams.classList.remove('loading')
    }


    //#region -- -- -- -- FILTER
    var filter = r.querySelector('.filter')
    filter.button = filter.querySelector('button')
    filter.list = filter.querySelector('.list')
    filter.active = { 'publishers': [], 'exams.categories': [] }


    var selectFilter = r.querySelector('.select-filter')
    selectFilter.random = {}
    selectFilter.filters = ['publishers', 'exams.categories']
    selectFilter.close = selectFilter.querySelector('.close')
    for (let type of selectFilter.filters) {
        let self = selectFilter.querySelector('.' + type.split('.').at(-1))
        selectFilter[type] = self
        self.random = {}
        self.ul = self.querySelector('ul')
        self.add = items => {
            for (let item of items) {
                let element = d.createElement('li')
                element.onclick = () => {
                    if (element.classList.contains('active')) element.classList.remove('active'), filter.active[type].splice(filter.active[type].indexOf(item), 1)
                    else element.classList.add('active'), filter.active[type].push(item)
                }
                if (filter.active[type].includes(item)) element.classList.add('active')
                element.innerText = item.name
                self.ul.appendChild(element)
            }
        }
        self.search = async query => {
            self.classList.add('loading')
            self.ul.innerHTML = ''
            const random = Math.random()
            self.random.search = random
            var data = await session.search(type, query)
            if (self.random.search = random) {
                self.classList.remove('loading')
                self.add(data)
            }
        }
        self.search.bar = self.querySelector('input')
        self.search.bar.oninput = () => {
            clearTimeout(self.search.timeout)
            self.search.timeout = setTimeout(() => self.search(self.search.bar.value), 300)
        }
    }
    selectFilter.load = filters => {
        for (let key of Object.keys(filters)) {
            selectFilter[key].add(filters[key])
            selectFilter[key].classList.remove('loading')
        }
    }
    selectFilter.close.onclick = async () => {
        selectFilter.style.display = 'none'
        filter.list.innerHTML = ''
        app.history.onpopstate = null

        let i = 0
        for (let filters of Object.values(filter.active)) {
            if (i == 1 && Object.values(filter.active).every(v => v.length)) filter.list.appendChild(d.createElement('hr'))
            for (let { name }  of filters) {
                let element = d.createElement('span')
                element.innerText = name
                filter.list.appendChild(element)
            }
            i++
        }
        exams.search()

	return false
    }


    filter.querySelector('button').onclick = async () => {
        selectFilter.style.display = 'block'
        for (let filter of selectFilter.filters) {
            selectFilter[filter].classList.add('loading')
            selectFilter[filter].ul.innerHTML = ''
        }
        app.history.onpopstate = selectFilter.close.onclick
        history.pushState(null, null)

        const random = Math.random()
        selectFilter.random.load = random
        filters = await session.dashboardFilters()
        if (selectFilter.random.load == random) selectFilter.load(filters)
    }
    //#endregion


    var analyze = r.querySelector('.analyze')
    analyze.button = analyze.querySelector('button.start')

    analyze.ul = analyze.querySelector('ul')
    analyze.ul.add = exam => {
        const li = d.createElement('li')
        li.innerHTML = `<span class="publisher">PUBLISHER</span>: <span class="category">CATEGORY</span> <span class="name">NAME</span>`
        li.dataset.id = exam.id
        li.querySelector('.name').innerText = exam.name
        li.querySelector('.publisher').innerText = exam.publisher.name
        li.querySelector('.category').innerText = exam.category.name
        analyze.ul.appendChild(li)
    }
    analyze.ul.remove = exam => {
        for (let li of analyze.ul.childNodes) if (li.dataset.id == exam.id) return li.remove()
    }

    analyze.list = []
    analyze.button.onclick = () => {
        if (r.classList.contains('analyze')) {
            r.classList.remove('analyze')
            analyze.list = []
            analyze.ul.innerHTML = ''
            for (let i of Array.from(exams.list.childNodes)) i.checked = false
            return 
        }
        r.classList.add('analyze')
        
    }
    analyze.add = element => {
        if (element.checked) analyze.list.push(element.exam), analyze.ul.add(element.exam)
        else analyze.list.splice(analyze.list.indexOf(element.exam), 1), analyze.ul.remove(element.exam)
    }
    Object.entries({
        'button.all': () => { for (let i of Array.from(exams.list.childNodes).reverse()) if (!i.checked) i.checked = true, i.oncheck(i) },
        'button.clear': () => { analyze.ul.innerHTML = ''; for (let i of Array.from(exams.list.childNodes)) i.checked = false, i.oncheck(i); analyze.list = [] },
        'button.ok': () => app.redirect(`/analiz/${analyze.list.map(exam => exam.id)}`)
    }).forEach(([item, listener]) => analyze.querySelector(item).onclick = listener)


    exams.load(r.data)
</script>
