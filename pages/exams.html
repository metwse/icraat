<script init>
    r.data = await session.dashboard.exams()
</script>


<div class="top">
    <a href="https://www.metw.cc" target="_blank">
        <svg onclick="" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
            <path fill="currentColor" d="M275,66.56V255.1c0,.85-.96,1.28-1.6,.85l-50.09-34.77c-.32-.11-.43-.43-.43-.85v-85.28c0-.43-.53-.64-.85-.32l-71.46,60.93c-.32,.32-.96,.32-1.28,0l-71.46-60.93c-.32-.32-.85-.11-.85,.32v85.18c0,.32-.11,.53-.43,.85l-49.98,34.77c-.74,.53-1.6,0-1.6-.85V66.56c0-.32,.11-.53,.32-.85l24.99-21.59c.32-.32,.96-.32,1.28,0l97.62,83.05c.32,.32,.96,.32,1.28,0L248.1,44.23c.32-.32,.96-.32,1.28,0l24.99,21.59c.53,.11,.64,.43,.64,.74h0Z"></path>
            <polygon fill="none" points="300 100 200 100 200 0 100 0 100 100 0 100 0 200 100 200 100 300 200 300 200 200 300 200"></polygon>
        </svg>
    </a>
    <input placeholder="Ara" />
    <a href="javascript:app.redirect('/yönet')" class="user">
        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"></path>
        </svg>
    </a>
    <a href="javascript:app.redirect('/yeni')" class="user">
        <svg  fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></path>
        </svg>
    </a>
    <a href="javascript:app.redirect('/giriş')">
        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"></path>
        </svg>
    </a>
</div>
<div class="main">
    <h2>Sınavlar</h2>
    <div class="content">
        <div class="buttons">
            <div class="filter">
                <div>
                    <button>
                        <div class="_inline-img">
                            Filtrele
                            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 13.5V3.75m0 9.75a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 3.75V16.5m12-3V3.75m0 9.75a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 3.75V16.5m-6-9V3.75m0 3.75a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 9.75V10.5"></path>
                            </svg>
                        </div>
                    </button>
                </div>
                <i-fancylist i-clicktoremove i-nowrap></i-fancylist>
            </div>
            <div class="analyze">
                <div>
                    <button class="start">
                        <div class="start _inline-img">
                            Analiz
                            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 107.5 7.5h-7.5V6z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z"></path>
                            </svg>
                        </div>
                        <div class="stop _inline-img" style="display: none">
                            İptal
                            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                    </button>
                    <div>
                        <button class="all analyze" style="display: none">
                            <div class="_inline-img">
                                Tümü
                                <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </button>
                        <button class="ok selected" style="display: none">
                            <div class="_inline-img">
                                Analiz Et
                                <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"></path>
                                </svg>
                            </div>
                        </button>
                        <button class="clear selected" style="display: none">
                            <div class="ok _inline-img">
                                Temizle
                                <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path>
                                </svg>
                            </div>
                        </button>
                    </div>
                </div>
                <i-fancylist i-clicktoremove></i-fancylist>
            </div>
        </div>

        <i-exams></i-exams>

        <div class="select-filter">
            <nav>
                <h3>Filtreler</h3>
                <svg class="close" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </nav>
            <i-search class="users" i-type="checkbox" i-title="kullanıcı" i-searchfunction="async query => session.search('users', query)"></i-search>
            <i-search class="publishers" i-type="checkbox" i-title="yayınevi" i-searchfunction="async query => session.search('publishers', query)"></i-search>
            <i-search class="exams categories" i-type="checkbox" i-title="kategori" i-searchfunction="async query => session.search('category', query)"></i-search>
        </div>
    </div>
</div>

<style>
.r { display: flex; flex-direction: column; gap: 2em }

.r .top { display: flex; padding: .75em 1em; border: 0.125em solid var(--bg-3); border-left-color: var(--t-1); border-right-color: var(--t-1); border-radius: 100em; align-items: center; gap: 1em }
.r .top svg { height: 1.5em }    
.r .top svg:hover { cursor: pointer }    
.r .top input { min-width: 0; border: none; background: none; outline: none; flex-grow: 1 }

/* ** ** ** ** */

.r .main { display: flex; flex-direction: column; flex-grow: 1 }
.r .main h2 { margin: 0; color: var(--color-3); font-size: 2em }
.r .main .content { position: relative; flex-grow: 1 }

/*{{{ CONTENT */

.r .content .buttons i-fancylist { margin: .25em 0 0; padding: 0 }
.r .content .buttons > * { margin-top: .5em }
.r .content .buttons > div > div:first-of-type { display: flex; justify-content: space-between; gap: .25em; flex-wrap: wrap }
.r .content .buttons > div > div:first-of-type > div { display: flex; gap: .25em; flex-wrap: wrap }
.r .content .buttons button { padding: .5em 1em; background: var(--bg-2); color: var(--color-2); border: .1em solid var(--bg-3); text-transform: uppercase; border-radius: 100em }
.r .content .buttons button svg { width: 1.25em; height: 1.25em }
.r .content .buttons button div { gap: .5em }

.r .content .analyze:has(i-fancylist:not(:empty)) button.selected { display: inline-flex !important }
.r .content .analyze i-fancylist:empty { display: none }
.r .content .analyze i-fancylist div .publisher { text-transform: uppercase }
.r .content .analyze i-fancylist div .name { text-decoration: underline var(--t-1) }

.r.analyze .content .analyze button .start { display: none }
.r.analyze .content .analyze button .stop { display: inline-flex !important }
.r.analyze .content .analyze .analyze { display: block !important }

/*}}}*/
/*{{{ SELECT FILTER */

.r .content .select-filter { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: var(--bg-2); z-index: 99 }

.r .content .select-filter nav { display: flex; padding: 1em 1em; border: .125em solid var(--bg-3); border-left: none; border-right: none; justify-content: space-between; align-items: center }
.r .content .select-filter nav h3 { margin: 0; text-transform: uppercase; font-weight: 500 }
.r .content .select-filter nav svg { padding: .2em; height: 1.6em; background: var(--bg-2); border-radius: 100%; transition: filter .1s }
.r .content .select-filter nav svg:hover { filter: brightness(1.1); cursor: pointer }

.r .content .select-filter hr { margin: .5em 0 0; border: .125em solid var(--bg-3); border-bottom: 0 }

/*}}}*/
</style>

<script>
    var search = r.querySelector('.top input')
    search.oninput = () => {
        clearTimeout(search.timeout)
        search.timeout = setTimeout(() => exams.search(search.value, filter.active), 300)
    }


    var exams = r.querySelector('i-exams')


    //{{{ FILTER 
    var filter = r.querySelector('.filter')
    filter.button = filter.querySelector('button')
    filter.ul = filter.querySelector('i-fancylist')
    filter.ul.schema = '{data.name}'
    filter.ul.onremove = data => {
        filter.active[({ Publisher: 'publishers', Category: 'exams.categories', User: 'users' })[Object.getPrototypeOf(data).constructor.name]].remove(data)
        exams.search(search.value, filter.active, 300)
    }
    filter.active = { 'publishers': [], 'exams.categories': [], 'users': [] }


    filter.select = r.querySelector('.select-filter')
    filter.select.random = {}, filter.select.search = {}
    filter.select.close = filter.select.querySelector('.close')

    for (let type of Object.keys(filter.active)) filter.select.search[type] = filter.select.querySelector(`.${type}`), filter.select.search[type].list = filter.active[type]
    filter.select.load = filters => {
        for (let key of Object.keys(filters)) {
            filter.select.search[key].concat(filters[key])
            filter.select.search[key].loading = false
        }
    }
    filter.select.close.onclick = async () => {
        filter.select.style.display = 'none'
        exams.style.display = 'unset'
        filter.ul.clear()
        filter.ul.concat2d(Object.values(filter.active))
        app.history.onpopstate = null
        exams.search(search.value, filter.active)
        return false
    }


    filter.querySelector('button').onclick = async () => {
        filter.select.style.display = 'block'
        exams.style.display = 'none'
        for (let key of Object.keys(filter.active)) {
            filter.select.search[key].loading = true
            filter.select.search[key].ul.innerHTML = ''
        }
        app.history.onpopstate = filter.select.close.onclick
        history.pushState(null, null)

        const random = Math.random()
        filter.select.random.load = random
        filters = await session.dashboard.examsFilters()
        if (filter.select.random.load == random) filter.select.load(filters)
    }
    //}}}


    //{{{ ANALYZE 
    var analyze = r.querySelector('.analyze')
    analyze.ul = analyze.querySelector('i-fancylist')
    analyze.ul.schema = '<span class="publisher">{data.publisher.name}</span>: <span class="category">{data.category.name}</span> <span class="name">{data.name}</span>'
    analyze.ul.onremove = exam => exams.select.deselect(exam)
    analyze.querySelector('button.start').onclick = () => {
        if (r.classList.contains('analyze')) {
            analyze.ul.clear()
            exams.select.stop()
        } else {
            const list = exams.select.start()
            list.onadd = e => analyze.ul.push(e)
            list.onremove = e => analyze.ul.remove(e)
            list.onclear = () => analyze.ul.clear()
        }
        r.classList.toggle('analyze')
    }
    Object.entries({
        'button.all': () => exams.select.all(true),
        'button.clear': () => exams.select.clear(),
        'button.ok': () => app.redirect(`/analiz/${exams.select.list.map(v => v.id)}`)
    }).forEach(([item, listener]) => analyze.querySelector(item).onclick = listener)
    //}}}


    exams.concat(r.data)
</script>
